<nav class="navbar navbar-dark bg-dark">
  <div class="container-fluid">
    <span class="navbar-brand mb-0 h5">Panel de Administración</span>
    <button class="btn btn-sm btn-outline-light" (click)="logout()">
      Cerrar Sesión
    </button>
  </div>
</nav>

<div class="container-fluid p-4">
  
  <div class="row mb-4">
    <div class="col">
      <h4 class="mb-0">Gestión de Productos</h4>
    </div>
    <div class="col-auto">
      <button class="btn btn-primary" (click)="toggleFormulario()">
        {{ mostrarFormulario ? 'Cancelar' : 'Nuevo Producto' }}
      </button>
    </div>
  </div>
  
  <div class="card mb-4" *ngIf="mostrarFormulario">
    <div class="card-header">
      {{ modoEdicion ? 'Editar Producto' : 'Nuevo Producto' }}
    </div>
    <div class="card-body">
      <form (ngSubmit)="guardarProducto()">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nombre</label>
            <input type="text" class="form-control" [(ngModel)]="productoForm.nombre" name="nombre" required>
          </div>
          
          <div class="col-md-6">
            <label class="form-label">Categoría</label>
            <select class="form-select" [(ngModel)]="productoForm.categoria" name="categoria">
              <option *ngFor="let cat of categorias" [value]="cat">{{ cat }}</option>
            </select>
          </div>

          <div class="col-12">
            <label class="form-label">Descripción</label>
            <textarea class="form-control" [(ngModel)]="productoForm.descripcion" name="descripcion" rows="2"></textarea>
          </div>

          <div class="col-md-4">
            <label class="form-label">Precio (S/)</label>
            <input type="number" step="0.01" class="form-control" [(ngModel)]="productoForm.precio" name="precio" required>
          </div>

          <div class="col-md-4">
            <label class="form-label">Cantidad</label>
            <input type="number" class="form-control" [(ngModel)]="productoForm.stock" name="stock" required>
          </div>

          <div class="col-md-4">
            <label class="form-label">Talla</label>
            <input type="text" class="form-control" [(ngModel)]="productoForm.talla" name="talla">
          </div>

          <div class="col-md-6">
            <label class="form-label">Color</label>
            <input type="text" class="form-control" [(ngModel)]="productoForm.color" name="color">
          </div>

          <div class="col-md-6">
            <label class="form-label">Imagen</label>
            <input type="file" accept="image/*" class="form-control" (change)="onFileSelected($event)">
            <div class="mt-2" *ngIf="previewUrl || productoForm.imagen_url">
              <img [src]="previewUrl || productoForm.imagen_url" alt="Preview" 
                   style="max-width:120px; max-height:120px; object-fit:cover; border:1px solid #ddd;">
            </div>
            <input type="hidden" [(ngModel)]="productoForm.imagen_url" name="imagen_url">
          </div>
        </div>

        <div class="mt-3">
          <button type="submit" class="btn btn-success me-2">
            {{ modoEdicion ? 'Actualizar' : 'Guardar' }}
          </button>
          <button type="button" class="btn btn-secondary" (click)="toggleFormulario()">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-header">Lista de Productos</div>
    <div class="card-body">
      
      <div *ngIf="isLoading" class="text-center py-4">
        <div class="spinner-border"></div>
      </div>

      <div *ngIf="!isLoading">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>ID</th>
              <th>Imagen</th>
              <th>Nombre</th>
              <th>Categoría</th>
              <th>Precio</th>
              <th>stock</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let producto of productos">
              <td>{{ producto.id }}</td>
              <td>
                <img [src]="producto.imagen_url" [alt]="producto.nombre" 
                     style="width: 50px; height: 50px; object-fit: cover;">
              </td>
              <td>{{ producto.nombre }}</td>
              <td>{{ producto.categoria }}</td>
              <td>S/ {{ producto.precio }}</td>
              <td>
                <span class="badge" 
                      [ngClass]="producto.stock > 10 ? 'bg-success' : (producto.stock > 0 ? 'bg-warning text-dark' : 'bg-danger')">
                  {{ producto.stock }}
                </span>
              </td>
              <td>
                <button class="btn btn-sm btn-outline-primary" (click)="editarProducto(producto)">
                  Editar
                </button>
                
              </td>
            </tr>
          </tbody>
        </table>

        <div *ngIf="productos.length === 0" class="alert alert-info">
          No hay productos
        </div>
      </div>

    </div>
  </div>

  <div class="card">
    <div class="card-header">Gestión de Pedidos</div>
    <div class="card-body">
      
      <div *ngIf="isLoadingPedidos" class="text-center py-4">
        <div class="spinner-border"></div>
      </div>

      <div *ngIf="!isLoadingPedidos">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>ID</th>
              <th>Código</th>
              <th>Total</th>
              <th>Estado</th>
              <th>Fecha</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let pedido of pedidos">
              <td>{{ pedido.id }}</td>
              <td>{{ pedido.codigo_seguimiento }}</td>
              <td>S/ {{ pedido.total }}</td>
              <td>
                <span class="badge" [ngClass]="'bg-' + getEstadoColor(pedido.estado)">
                  {{ pedido.estado }}
                </span>
              </td>
              <td>{{ pedido.fecha_pedido | date:'dd/MM/yy HH:mm' }}</td>
              <td>
                <button class="btn btn-sm btn-outline-secondary" 
                        data-bs-toggle="modal" 
                        [attr.data-bs-target]="'#modal' + pedido.id">
                  Cambiar
                </button>
                
                <div class="modal fade" [id]="'modal' + pedido.id" tabindex="-1">
                  <div class="modal-dialog modal-sm">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h6 class="modal-title">Pedido #{{ pedido.id }}</h6>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <label class="form-label">Estado actual: <strong>{{ pedido.estado }}</strong></label>
                        <select class="form-select" [(ngModel)]="pedido.nuevoEstado">
                          <option value="pendiente">Pendiente</option>
                          <option value="procesando">Procesando</option>
                          <option value="enviado">Enviado</option>
                          <option value="entregado">Entregado</option>
                          <option value="cancelado">Cancelado</option>
                        </select>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-sm btn-primary" 
                                (click)="confirmarCambioEstado(pedido)" 
                                data-bs-dismiss="modal">
                          Confirmar
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <div *ngIf="pedidos.length === 0" class="alert alert-info">
          No hay pedidos
        </div>
      </div>

    </div>
  </div>

</div>